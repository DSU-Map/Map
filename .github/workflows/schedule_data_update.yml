name: ğŸ—“ï¸ Update Menu Data (CROSS-REPO FIX)

on:
  workflow_dispatch:
  # ì´ë¯¸ì§€ íŒŒì¼ ë³€ê²½ ì‹œ ìë™ ì‹¤í–‰ì€ Map ì €ì¥ì†Œì— í•œì •ë˜ë¯€ë¡œ, 
  # backend ì €ì¥ì†Œì˜ ë³€ê²½ì€ ìŠ¤ì¼€ì¤„ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
  schedule:
    - cron: "0 2 * * *" # UTC 02:00 (KST 11:00 AM)

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      # 1. ğŸ“‚ ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆëŠ” 'backend' ì €ì¥ì†Œ ë‹¤ìš´ë¡œë“œ
      - name: 1. Checkout Backend Repository (Script Source)
        uses: actions/checkout@v4
        with:
          repository: DSU-Map/backend
          path: backend_repo # ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ì„ ì´ í´ë”ì— ì €ì¥
          token: ${{ secrets.GITHUB_TOKEN }} # ë¹„ê³µê°œ ì €ì¥ì†Œ ì ‘ê·¼ í† í°

      # 2. ğŸ“‚ JSON íŒŒì¼ì„ ì €ì¥í•  'Map' ì €ì¥ì†Œ ë‹¤ìš´ë¡œë“œ
      - name: 2. Checkout Map Project (JSON Target)
        uses: actions/checkout@v4
        with:
          repository: DSU-Map/Map
          path: Map_Project # JSON íŒŒì¼ì„ ì»¤ë°‹í•  í´ë”

      # 3. Python í™˜ê²½ ë° ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
      - name: 3. Set up Python and Install Dependencies
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: pip install google-genai pillow

      # 4. ğŸš€ OCR ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: 4. Run OCR script
        working-directory: backend_repo # ìŠ¤í¬ë¦½íŠ¸ í´ë” ì•ˆì—ì„œ ì‹¤í–‰
        run: |
          # âœ… ì¤‘ìš”: ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰. ocr_importer_local.py íŒŒì¼ì˜ JSON ì €ì¥ ê²½ë¡œê°€ 
          # ë°˜ë“œì‹œ ../Map_Project/Public/menu_data.jsonì„ ê°€ë¦¬ì¼œì•¼ í•©ë‹ˆë‹¤.
          python ocr_importer_local.py
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      # 5. ğŸ“¦ ë³€ê²½ëœ JSON íŒŒì¼ ì»¤ë°‹ ë° í‘¸ì‹œ
      - name: 5. Commit and Push JSON update
        working-directory: Map_Project # JSONì´ ì €ì¥ëœ Map_Project í´ë” ì•ˆì—ì„œ Git ëª…ë ¹ ì‹¤í–‰
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          # Public/menu_data.json íŒŒì¼ì´ Map_Project í´ë” ì•ˆì— ìˆë‹¤ê³  ê°€ì •
          git add Public/menu_data.json
          
          git commit -m "chore(data): Auto-update menu data [skip ci]" || echo "No changes to commit"
          # Map ì €ì¥ì†Œì— í‘¸ì‹œ
          git push
